# 2026-02-13 聊天消息元信息可见性设计（附件 + 技能）

## 1. 背景

当前附件能力已上线，但存在可见性体验缺口：
- `+` 上传入口缺少明确文案提示（仅符号）。
- 发送后会话只显示问题文本，不显示本条上传的文件。
- 教师端发送后会话不显示本条使用的技能，仅输入区可见。

用户期望：接近 ChatGPT 的消息可见性，发送后在会话中看到“本条技能 + 附件卡片”。

## 2. 目标与范围

### 2.1 目标

- 在教师端与学生端聊天消息中显示本条附件卡片。
- 在教师端聊天消息中显示本条实际请求使用的技能标签（仅请求带 `skill_id` 时显示）。
- 将 `+` 按钮改为明确文案“上传文件”，并补充提示信息。
- 保证刷新和历史回放后仍可稳定显示上述元信息。

### 2.2 非目标

- 本期不实现拍照二级菜单。
- 本期不显示附件解析文本摘要，仅展示文件元信息。
- 不重构历史主存储结构，仅做最小兼容扩展。

## 3. 方案结论

采用混合方案：
- 前端发送瞬间本地插入结构化元信息，保证即时可见。
- 后端在用户消息持久化 `meta` 中落盘技能与附件快照，保证刷新/历史回放一致。

不采用纯前端文本拼接方案（刷新丢语义）；不采用一次性大重构方案（改动面过大）。

## 4. UI 设计

### 4.1 输入区

- 教师端与学生端 `+` 按钮改为“上传文件”。
- 保持单击直接上传文件，不增加二级菜单。
- 增加 `title/aria-label`：
  - “上传文件（支持 markdown/xls/xlsx/pdf/图片，单文件 10MB 内）”。

### 4.2 会话消息

用户消息气泡顶部新增 `metadata` 区块：
- 教师端：
  - 可选技能标签（例如 `$physics-homework-generator`）。
  - 附件卡片（图标 + 文件名 + 文件大小）。
- 学生端：
  - 仅附件卡片。

显示规则：
- 技能标签仅当本条请求体真实携带 `skill_id` 时显示。
- 自动路由且未显式技能时不显示技能标签。
- 附件卡片仅显示发送成功进入会话的附件（`ready` 附件快照）。

## 5. 数据模型

### 5.1 前端消息模型扩展

新增 `MessageMeta`：
- `skillId?: string`
- `attachments?: Array<{ attachmentId: string; fileName: string; sizeBytes: number; mime?: string }>`

在本地发送消息入列时填充：
- 教师端：`skillId + attachments`。
- 学生端：`attachments`。

### 5.2 后端持久化扩展

在用户消息 prewrite 阶段写入 `meta`（不修改 `content`）：
- `skill_id_effective`（可选）
- `attachments`（数组，字段：`attachment_id/file_name/size_bytes/content_type`）

历史接口继续返回 `messages[]`，每条消息可选携带 `meta`（兼容老数据）。

## 6. 流程与时序

1. 用户上传文件，输入区显示附件条。
2. 点击发送：
   - 本地插入用户消息（含 metadata 区）。
   - 调用 `/chat/start`（含 `skill_id` 与 `attachments`）。
3. 发送成功：
   - 保留会话消息中的 metadata。
   - 清空输入区已就绪附件条。
4. 刷新/重进会话：
   - 前端从历史消息 `meta` 恢复 metadata 展示。

## 7. 异常处理

- 若发送失败：
  - 保持失败提示并避免产生误导性的“已发送元信息”状态。
- 若历史消息无 `meta`（旧数据）：
  - 正常降级为纯文本展示。
- 若附件文件后续被删除：
  - 历史仍展示发送时快照（不依赖实时文件读取）。

## 8. 测试策略

### 8.1 前端

- 组件/集成测试：
  - 消息 metadata 渲染（教师技能标签显隐 + 附件卡片）。
  - 发送后输入区附件清空但会话保留附件卡片。
  - `+` 按钮文案与可访问性属性。

### 8.2 后端

- prewrite 落盘测试：
  - 用户消息 `meta` 正确写入 `skill_id_effective` 与 `attachments`。
- 历史接口兼容测试：
  - 有/无 `meta` 均可返回并被前端消费。

### 8.3 E2E

- 教师端：上传附件 + 指定技能发送后，会话显示技能标签和附件卡片。
- 学生端：仅附件发送后，会话显示附件卡片。

## 9. 落地切片

- Slice A：按钮文案与提示改造（教师/学生）。
- Slice B：前端消息 metadata 模型与渲染。
- Slice C：后端用户消息 `meta` 落盘。
- Slice D：历史回放读取 `meta`。
- Slice E：测试补齐（单测 + E2E）。

## 10. 验收标准

- 用户发送带附件消息后，会话内可见文件卡片。
- 教师端带 `skill_id` 的请求，会话内可见本条技能标签。
- 刷新页面后，历史消息仍显示对应附件/技能元信息。
- 无 `meta` 的旧历史消息不受影响。

