# 全栈严格代码审计设计方案

日期: 2026-02-13
状态: 已批准，待执行
范围: 全栈（后端 + 前端 + 基础设施）
方法: 风险分层扫描
产出: 审计报告 + 确认后修复

## 背景

上次系统性 bug 审计（2026-02-11）覆盖了 services/api 的核心模块，修复了路径遍历、
多租户泄漏、静默异常吞没等 14 个问题。此后新增了 persona 系统、chat attachments、
multi-angle scoring 等功能，且前端、基础设施从未被审计。

当前状态：1785 测试（1781 通过，2 失败，2 跳过）。

## 风险评分模型（5 维度）

| 维度 | 1 分 | 3 分 | 5 分 |
|------|------|------|------|
| 代码量 | <50 行 | 150-300 行 | >500 行 |
| 复杂度 | 纯计算/静态配置 | 文件读写/网络调用 | 并发+外部调用+动态执行 |
| 暴露面 | 内部工具函数 | 间接可达（worker/后台） | 直接处理用户输入/HTTP 请求 |
| 测试覆盖 | 完整测试 | 部分覆盖 | 零测试或仅结构测试 |
| 变更频率 | 上次审计后未改动 | 小幅修改 | 新增或大幅重写 |

总分 = 各维度之积。T1（>300）深度审计，T2（100-300）标准审计，T3（<100）快速扫描。

## 审计规则清单（10 条）

### 后端规则（延续 + 扩展）

1. **输入边界验证** — API 参数格式校验、文件名/ID/路径 sanitize、类型强制转换安全
2. **文件 I/O 安全** — 路径可控性、临时文件清理、原子写入、符号链接攻击
3. **并发与竞态** — 文件锁 TOCTOU、共享状态锁保护、contextvars 正确性、asyncio 安全
4. **错误处理** — 静默吞错、资源泄漏（未释放锁/未关闭文件）、异常传播链完整性
5. **数据完整性** — JSON/CSV 编码错误、None/NaN/除零、数据截断/溢出
6. **多租户隔离** — get_app_core() vs 直接 import、硬编码路径、全局状态污染

### 新增全栈规则

7. **前端安全** — XSS（dangerouslySetInnerHTML、未转义用户内容）、敏感数据暴露、CSRF
8. **API 契约** — 前后端类型不一致、缺失的错误状态处理、未授权端点访问
9. **基础设施安全** — Docker 权限配置、secrets 管理、端口暴露、健康检查完整性
10. **性能隐患** — N+1 查询模式、无界列表/分页缺失、大文件内存加载、缺失的超时/限流

## 执行阶段

### Phase 1：高危后端模块（新增 + 大型未审计）

| 模块 | 行数 | 审计重点 | 原因 |
|------|------|----------|------|
| persona 相关模块（新增） | ~500+ | 规则1+6+8 | 全新功能，零审计历史 |
| chat attachment 相关（新增） | ~300+ | 规则1+2 | 全新功能 |
| multi-angle scoring（新增） | ~400+ | 规则1+5 | 全新功能 |
| exam_upload_parse_service.py | 971 | 规则1+2+4 | 最大模块，上次未深审 |
| agent_service.py | 711 | 规则1+3+4 | 核心模块，高复杂度 |
| chat_job_processing_service.py | 652 | 规则3+4 | 核心模块 |
| llm_gateway.py | 587 | 规则1+4+10 | 所有 LLM 调用入口 |

### Phase 2：前端安全审计

| 目标 | 审计重点 |
|------|----------|
| Teacher App (66 文件) | 规则7：XSS、敏感数据暴露、权限控制 UI |
| Student App (28 文件) | 规则7：用户输入处理、persona 数据展示 |
| Shared Utils (12 文件) | 规则8：API 调用封装、错误处理、token 管理 |
| E2E Tests (35 specs) | 检查测试覆盖盲区 |

### Phase 3：API 契约一致性

- 前后端类型定义对比（TS types vs Python models）
- 缺失的错误状态码处理
- 未授权/未认证端点排查
- 请求/响应 schema 验证

### Phase 4：基础设施与配置

| 目标 | 审计重点 |
|------|----------|
| docker-compose.yml | 规则9：权限、secrets、端口暴露、资源限制 |
| CI workflows (4 个) | 规则9：secrets 泄漏、权限范围、缓存安全 |
| scripts/ (21 个) | 规则2+1：脚本注入、文件操作安全 |
| config/ | 规则4：配置加载容错 |

### Phase 5：性能与健壮性扫描

- 无界列表/分页缺失排查
- 大文件内存加载模式
- 缺失的超时设置（HTTP 调用、文件锁等待）
- N+1 模式
- 全局状态/缓存无界增长

## 每个模块的审计工作流

1. **静态分析** — 逐行阅读代码，对照 10 条规则逐条检查
2. **数据流追踪** — 从用户输入到最终处理，追踪完整数据流
3. **边界条件枚举** — 空值、超长输入、特殊字符、并发场景、类型不匹配
4. **问题记录** — 位置、描述、严重级别、修复方案、影响范围
5. **修复验证** — 确认后编写修复代码 + 回归测试

## 严重级别定义

- **H（高危）**：可被外部利用的安全漏洞，或可导致数据丢失/泄漏的逻辑错误
- **M（中危）**：需要特定条件触发的 bug，或影响功能正确性但不涉及安全的问题
- **L（低危）**：代码异味、潜在的性能问题、健壮性不足但当前不会触发的问题

## 产出

- 每个 Phase 完成后输出审计报告
- 汇总到 `docs/plans/2026-02-13-code-audit-findings.md`
- 修复代码 + 测试在确认后提交
