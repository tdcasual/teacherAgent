version: "3.9"

services:
  api:
    build:
      context: .
      dockerfile: services/api/Dockerfile
    ports:
      - "8000:8000"
    env_file: .env
    environment:
      - DATA_DIR=/app/data
      - UPLOADS_DIR=/app/uploads
      - QDRANT_PATH=/app/.qdrant
      - MEM0_DIR=/app/.mem0
    volumes:
      - ./data:/app/data
      - ./.qdrant:/app/.qdrant
      - ./.mem0:/app/.mem0
      - ./uploads:/app/uploads
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 5s
      retries: 3

  mcp:
    build:
      context: .
      dockerfile: services/mcp/Dockerfile
    ports:
      - "9000:9000"
    env_file: .env
    environment:
      - DATA_DIR=/app/data
      - MCP_API_KEY=${MCP_API_KEY}
    volumes:
      - ./data:/app/data
      - ./.qdrant:/app/.qdrant
      - ./.mem0:/app/.mem0
      - ./uploads:/app/uploads
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:9000/health')"]
      interval: 30s
      timeout: 5s
      retries: 3

  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile
      args:
        VITE_API_URL: ${VITE_API_URL:-http://localhost:8000}
        VITE_MCP_URL: ${VITE_MCP_URL:-http://localhost:9000}
    ports:
      - "3000:80"
    depends_on:
      - api

  # Optional Qdrant service (enable with: docker compose --profile qdrant up)
  qdrant:
    image: qdrant/qdrant:latest
    profiles: ["qdrant"]
    ports:
      - "6333:6333"
    volumes:
      - ./.qdrant:/qdrant/storage
