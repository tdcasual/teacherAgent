version: "3.9"

services:
  api:
    build:
      context: .
      dockerfile: services/api/Dockerfile
    command: ["uvicorn", "services.api.app:app", "--host", "0.0.0.0", "--port", "8000", "--workers", "${API_WORKERS:-2}"]
    ports:
      - "8000:8000"
    env_file: .env
    environment:
      - DATA_DIR=/app/data
      - UPLOADS_DIR=/app/uploads
      - JOB_QUEUE_BACKEND=rq
      - REDIS_URL=redis://redis:6379/0
      - QDRANT_PATH=/app/.qdrant
      - MEM0_DIR=/app/.mem0
      - LLM_MAX_CONCURRENCY_STUDENT=${LLM_MAX_CONCURRENCY_STUDENT:-12}
      - LLM_MAX_CONCURRENCY_TEACHER=${LLM_MAX_CONCURRENCY_TEACHER:-2}
      - CHAT_STUDENT_INFLIGHT_LIMIT=${CHAT_STUDENT_INFLIGHT_LIMIT:-1}
      - CHAT_MAX_MESSAGES_STUDENT=${CHAT_MAX_MESSAGES_STUDENT:-40}
      - PROFILE_UPDATE_ASYNC=${PROFILE_UPDATE_ASYNC:-1}
      - PROFILE_CACHE_TTL_SEC=${PROFILE_CACHE_TTL_SEC:-10}
      - ASSIGNMENT_DETAIL_CACHE_TTL_SEC=${ASSIGNMENT_DETAIL_CACHE_TTL_SEC:-10}
      - DEFAULT_TEACHER_ID=${DEFAULT_TEACHER_ID:-teacher}
    volumes:
      - ./data:/app/data
      - ./.qdrant:/app/.qdrant
      - ./.mem0:/app/.mem0
      - ./uploads:/app/uploads
    depends_on:
      - redis
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 5s
      retries: 3

  mcp:
    build:
      context: .
      dockerfile: services/mcp/Dockerfile
    ports:
      - "9000:9000"
    env_file: .env
    environment:
      - DATA_DIR=/app/data
      - MCP_API_KEY=${MCP_API_KEY}
    volumes:
      - ./data:/app/data
      - ./.qdrant:/app/.qdrant
      - ./.mem0:/app/.mem0
      - ./uploads:/app/uploads
    healthcheck:
      test: ["CMD", "python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:9000/health')"]
      interval: 30s
      timeout: 5s
      retries: 3

  worker:
    build:
      context: .
      dockerfile: services/api/Dockerfile
    command: ["python3", "-m", "services.api.workers.rq_worker"]
    env_file: .env
    environment:
      - DATA_DIR=/app/data
      - UPLOADS_DIR=/app/uploads
      - JOB_QUEUE_BACKEND=rq
      - REDIS_URL=redis://redis:6379/0
      - RQ_SCAN_PENDING_ON_START=${RQ_SCAN_PENDING_ON_START:-0}
    volumes:
      - ./data:/app/data
      - ./.qdrant:/app/.qdrant
      - ./.mem0:/app/.mem0
      - ./uploads:/app/uploads
    depends_on:
      - redis

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  frontend_student:
    build:
      context: .
      dockerfile: frontend/Dockerfile.student
      args:
        VITE_API_URL: ${VITE_API_URL:-http://localhost:8000}
    ports:
      - "3001:80"
    depends_on:
      - api

  frontend_teacher:
    build:
      context: .
      dockerfile: frontend/Dockerfile.teacher
      args:
        VITE_API_URL: ${VITE_API_URL:-http://localhost:8000}
    ports:
      - "3002:80"
    depends_on:
      - api

  # Optional Qdrant service (enable with: docker compose --profile qdrant up)
  qdrant:
    image: qdrant/qdrant:latest
    profiles: ["qdrant"]
    ports:
      - "6333:6333"
    volumes:
      - ./.qdrant:/qdrant/storage
